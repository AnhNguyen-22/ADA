<!DOCTYPE html>
<html>
<head>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta charset="utf-8"/>
<title>AirSense HCMC - Theo dõi trạm</title>
<link href="../assets/css/station-tracking.css" rel="stylesheet"/>
<link href="../components/sidebar.css" rel="stylesheet"/>
<link href="../components/dropdown.css" rel="stylesheet"/>
<link href="../assets/css/main.css" rel="stylesheet"/>
</head>
<script src="../assets/js/station-tracking.js"></script>
<body>
<div class="station-tracking-page">
    <!-- Background -->
    <div class="background" aria-hidden="true">
        <div class="background-overlay"></div>
        <img src="../assets/img/background.png" alt="" class="background-image">
    </div>
    <!-- Main Content-->
    <main class="main-content">
        <!-- Header -->
        <header class="content-header">
            <h1 class="main-title">THEO DÕI TRẠM</h1>
            <div class="header-info">
                <div class="header-meta-item">
                    <img class="header-meta-icon" src="https://c.animaapp.com/aROkQ2yh/img/place-marker@2x.png" alt="" aria-hidden="true"/>
                    <span class="location-text">Thành phố Hồ Chí Minh</span>
                </div>
                <div class="header-meta-item">
                    <img class="header-meta-icon" src="https://c.animaapp.com/aROkQ2yh/img/world-health-organization@2x.png" alt="" aria-hidden="true"/>
                    <span class="guideline-text">WHO guideline: PM2.5 24h = 15 µg/m³</span>
                </div>
            </div>
        </header>


        <!-- Two Column Layout -->
        <div class="two-column-layout">
            <!-- Left Card: PM2.5 Station Section -->
            <div class="pm25-station-section">
                <div class="section-header">
                    <h2 class="card-title">Chỉ số PM2.5 tại Trạm</h2>
                    <p class="section-subtitle">Trung bình ~ 37.8 µg/m³</p>
                </div>

                <div class="station-controls">
                    <!-- Station Dropdown Component -->
                    <div class="dropdown-container" id="station-dropdown" style="position: relative; width: 250px;">
                        <button class="dropdown-button" type="button" aria-haspopup="true" aria-expanded="false">
                            <span class="dropdown-button-text">S1 - Giao thông</span>
                            <span class="dropdown-arrow">&#9662;</span>
                        </button>
                        <div class="dropdown-menu" role="menu">
                            <!-- Items sẽ được render tự động -->
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div class="status-badge status-bad">
                        Xấu
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="graph-container" id="pm25-graph">
                    <h3 class="chart-title">PM2.5 — Tổng trạm</h3>
                    <canvas id="pm25-chart"></canvas>
                </div>
            </div>

            <!-- Right Card: Station Information -->
            <div class="station-info-section">
                <div class="section-header">
                    <h2 class="card-title">Thông tin Trạm</h2>
                    <div class="status-badge status-bad" style="position: absolute; top: 0; right: 0;">
                        Xấu
                    </div>
                </div>

                <!-- Circular Gauge Chart -->
<div class="gauge-container">
                    <canvas id="gauge-chart"></canvas>
                    <div class="gauge-value" id="gauge-value">45</div>
                    <div class="gauge-unit">µg/m³</div>
                    <div class="gauge-subtitle">Chỉ số PM2.5 trung bình</div>
                </div>

                <!-- Station Info List - Dynamic Content -->
                <ul class="station-info-list" id="station-info-list">
                    <li>Đang tải thông tin trạm...</li>
                </ul>

                <!-- Comparison Bar Chart -->
                <div class="comparison-chart-container">
                    <h3 class="card-title">So sánh chỉ số PM2.5 tại Trạm <span id="station-name-display">S1</span></h3>
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- AQI Scale Section -->
        <div class="aqi-scale-section">
            <h2 class="card-title">Thang đo chỉ số chất lượng không khí (AQI)</h2>
            <div class="aqi-gradient-bar">
                <div class="aqi-segment aqi-good" style="flex: 1;">
                    <div class="aqi-label">Tốt</div>
                    <div class="aqi-range">0-50</div>
                </div>
                <div class="aqi-segment aqi-moderate" style="flex: 1;">
                    <div class="aqi-label">Trung bình</div>
                    <div class="aqi-range">51-100</div>
                </div>
                <div class="aqi-segment aqi-poor" style="flex: 1;">
                    <div class="aqi-label">Kém</div>
                    <div class="aqi-range">101-150</div>
                </div>
                <div class="aqi-segment aqi-bad" style="flex: 1;">
                    <div class="aqi-label">Xấu</div>
                    <div class="aqi-range">151-200</div>
                </div>
                <div class="aqi-segment aqi-very-bad" style="flex: 1;">
                    <div class="aqi-label">Rất xấu</div>
                    <div class="aqi-range">201-300</div>
                </div>
                <div class="aqi-segment aqi-hazardous" style="flex: 1;">
                    <div class="aqi-label">Nguy hại</div>
                    <div class="aqi-range">301+</div>
                </div>
            </div>
        </div>

        <!-- ===================== ADDED: GOVERNMENT EXTRA (CHỈ HIỆN KHI ĐĂNG NHẬP) ===================== -->
        <div class="aqi-scale-section" id="government-extra-section" style="display:none;">
            <h2 class="card-title">Phân tích dành cho Cơ quan quản lý</h2>

            <!-- Exceedance theo giờ -->
            <div class="comparison-chart-container" style="margin-top: 16px;">
                <h3 class="card-title">Vượt ngưỡng theo giờ (cao hơn WHO 15 µg/m³) — <span id="gov-station-name-exceedance">S1</span></h3>
                <p style="margin: 6px 0 40px; color: #555; font-size: 15px;">
                    Chart minh hoạ: phần vượt ngưỡng WHO tại từng mốc giờ (0:00 → 22:00).
                </p>
                <canvas id="exceedance-hourly-chart" style="width:100%; display:block; margin-top: 12px;"></canvas>
            </div>

            <!-- So sánh cùng loại (ADD dropdown) -->
            <div class="comparison-chart-container" style="margin-top: 16px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                    <div>
                        <h3 class="card-title" style="margin:0;">So sánh với trạm cùng loại  — <span id="gov-station-name-same-type">S1</span></h3>
                        <p style="margin: 6px 0 40px; color: #555; font-size: 15px;">
                            Chọn 1 trạm cùng loại để so sánh (hoặc “All” để xem toàn bộ cùng loại).
                        </p>
                    </div>

                    <div class="dropdown-container" id="gov-same-type-dropdown" style="position: relative; width: 260px;">
                        <button class="dropdown-button" type="button" aria-haspopup="true" aria-expanded="false">
                            <span class="dropdown-button-text">Tất cả </span>
                            <span class="dropdown-arrow">&#9662;</span>
                        </button>
                        <div class="dropdown-menu" role="menu"></div>
                    </div>
                </div>

                <canvas id="same-type-comparison-chart" style="width:100%; display:block; margin-top: 12px;"></canvas>
            </div>

            <!-- So sánh khác loại (ADD dropdown) -->
            <div class="comparison-chart-container" style="margin-top: 16px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                    <div>
                        <h3 class="card-title" style="margin:0;">So sánh với trạm khác loại — <span id="gov-station-name-diff-type">S1</span></h3>
                        <p style="margin: 6px 0 40px; color: #555; font-size: 15px;">
                            Chọn 1 trạm khác loại để so sánh trực tiếp với trạm đang chọn.
                        </p>
                    </div>

                    <div class="dropdown-container" id="gov-diff-type-dropdown" style="position: relative; width: 260px;">
                        <button class="dropdown-button" type="button" aria-haspopup="true" aria-expanded="false">
                            <span class="dropdown-button-text">Chọn trạm khác loại</span>
                            <span class="dropdown-arrow">&#9662;</span>
                        </button>
                        <div class="dropdown-menu" role="menu"></div>
                    </div>
                </div>

                <canvas id="diff-type-comparison-chart" style="width:100%; display:block; margin-top: 12px;"></canvas>
            </div>
        </div>
        <!-- ===================== /ADDED: GOVERNMENT EXTRA ===================== -->

    </main>

    <!-- Sidebar Component -->
    <aside class="side-ql-unchoose" id="sidebar">
        <!-- Logo ở trên cùng -->
        <img class="image-3 logo-large" src="../assets/img/logo_lon.png" alt="AirSense HCMC Logo" id="sidebar-logo"/>
        <img class="image-3 logo-small" src="../assets/img/logo_nho.png" alt="AirSense HCMC Logo Small" id="sidebar-logo-small" style="display: none;"/>

        <!-- Toggle Button -->
        <img class="show-left-side-panel" id="sidebarToggle" src="https://c.animaapp.com/aROkQ2yh/img/show-left-side-panel@2x.png" alt="Toggle sidebar" style="cursor: pointer;"/>

        <!-- Mode Switcher -->
        <div class="group-12">
            <div class="rectangle-26"></div>
            <div class="rectangle-27"></div>
            <div class="text-wrapper-76" data-mode="public">Công khai</div>
            <div class="text-wrapper-77" data-mode="management">Quản lý</div>
        </div>

        <!-- Active Menu Item Background -->
        <div class="rectangle-28"></div>

        <!-- Navigation Icons -->
        <a href="overview.html" class="nav-link" data-page="overview">
            <img class="analyze" src="https://c.animaapp.com/aROkQ2yh/img/analyze@2x.png" alt="Tổng quan"/>
            <div class="text-wrapper-78">Tổng quan</div>
        </a>

        <a href="station-tracking.html" class="nav-link active" data-page="station-tracking">
            <img class="place-marker-2" src="https://c.animaapp.com/aROkQ2yh/img/place-marker-1@2x.png" alt="Theo dõi theo trạm"/>
            <div class="theo-d-i-tr-m">Theo dõi theo trạm</div>
        </a>

        <a href="recommendations.html" class="nav-link" data-page="recommendations">
            <img class="good-quality" src="https://c.animaapp.com/aROkQ2yh/img/good-quality@2x.png" alt="Khuyến cáo"/>
            <div class="text-wrapper-79">Khuyến cáo</div>
        </a>

        <a href="dataset.html" class="nav-link" data-page="dataset">
            <img class="database" src="https://c.animaapp.com/aROkQ2yh/img/database@2x.png" alt="Dữ liệu"/>
            <div class="text-wrapper-80">Dữ liệu</div>
        </a>

        <a href="model-evaluation.html" class="nav-link" data-page="model-evaluation">
            <img class="intelligence" src="https://c.animaapp.com/aROkQ2yh/img/intelligence@2x.png" alt="Đánh giá mô hình"/>
            <div class="text-wrapper-81">Đánh giá mô hình</div>
        </a>

        <a href="policy-suggestions.html" class="nav-link" data-page="policy-suggestions">
            <img class="light-on" src="https://c.animaapp.com/aROkQ2yh/img/light-on@2x.png" alt="Gợi ý chính sách"/>
            <div class="text-wrapper-82">Gợi ý chính sách</div>
        </a>

        <!-- User Profile Section -->
        <div class="group-11">
            <div class="rectangle-25"></div>
            <img class="image-2" src="../assets/img/avatar.jpeg" alt="Avatar"/>
            <div class="text-wrapper-74">Quản lý</div>
            <p class="text-wrapper-75">Bạn đang ở trang quản lý</p>
            <img class="logout-rounded" src="https://c.animaapp.com/aROkQ2yh/img/logout-rounded@2x.png" alt="Logout" style="cursor: pointer;"/>
        </div>
    </aside>
</div>

<script src="../components/sidebar.js"></script>
<script src="../components/dropdown.js"></script>

<script>
    // Khởi tạo khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        // Update active link for station-tracking in sidebar
        const stationLink = document.querySelector('a[href="station-tracking.html"]');
        if (stationLink) {
            stationLink.classList.add('active');
            // Remove active from other links
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link !== stationLink) {
                    link.classList.remove('active');
                }
            });
        }

        // Dữ liệu PM2.5 cho các trạm theo thời gian trong ngày (12 điểm: 0:00, 2:00, ..., 22:00)
        const timeLabels = ['0:00', '2:00', '4:00', '6:00', '8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'];
        const stationPM25Data = {
            's1': [32, 34, 36, 38, 40, 42, 41, 39, 37, 35, 33, 32],
            's2': [25, 27, 29, 31, 30, 32, 31, 29, 28, 27, 26, 25],
            's3': [35, 37, 39, 41, 43, 45, 44, 42, 40, 38, 36, 35],
            's4': [45, 47, 49, 51, 53, 55, 54, 52, 50, 48, 46, 45],
            's5': [30, 32, 34, 36, 35, 37, 36, 34, 33, 32, 31, 30],
            's6': [22, 24, 26, 28, 27, 29, 28, 26, 25, 24, 23, 22]
        };

        // Hàm tính giá trị trung bình
        function calculateAverage(values) {
            return Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 10) / 10;
        }

        // Hàm tạo giải thích động cho trạm
        function generateStationExplanation(stationId) {
            const stationAvg = calculateAverage(stationPM25Data[stationId]);
            const hcmcAvg = 35; // Trung bình TP.HCM
            const whoGuideline = 15; // Ngưỡng WHO
            
            // Tính trạm có PM2.5 cao nhất và thấp nhất
            const allStations = Object.keys(stationPM25Data);
            const stationAverages = allStations.map(s => ({
                id: s,
                avg: calculateAverage(stationPM25Data[s])
            }));
            stationAverages.sort((a, b) => b.avg - a.avg);
            
            const highestStation = stationAverages[0];
            const lowestStation = stationAverages[stationAverages.length - 1];
            
            const explanations = [];
            
            // So sánh với WHO
            if (stationAvg > whoGuideline) {
                const diff = Math.round(stationAvg - whoGuideline);
                explanations.push(`Chỉ số PM2.5 của trạm cao hơn ngưỡng khuyến cáo WHO (15 µg/m³) là ${diff} µg/m³.`);
            } else {
                explanations.push(`Chỉ số PM2.5 của trạm nằm trong ngưỡng an toàn theo khuyến cáo WHO (15 µg/m³).`);
            }
            
            // So sánh với trung bình TP
            if (stationAvg > hcmcAvg) {
                explanations.push(`Trạm này có mức ô nhiễm cao hơn trung bình TP.HCM (${hcmcAvg} µg/m³).`);
            } else if (stationAvg < hcmcAvg) {
                explanations.push(`Trạm này có mức ô nhiễm thấp hơn trung bình TP.HCM (${hcmcAvg} µg/m³).`);
            } else {
                explanations.push(`Trạm này có mức ô nhiễm bằng trung bình TP.HCM (${hcmcAvg} µg/m³).`);
            }
            
            // So sánh với các trạm khác
            if (stationId === highestStation.id) {
                explanations.push(`Đây là trạm có mức ô nhiễm cao nhất trong hệ thống.`);
            } else if (stationId === lowestStation.id) {
                explanations.push(`Đây là trạm có chất lượng không khí tốt nhất trong hệ thống.`);
            } else {
                const diff1 = Math.round(highestStation.avg - stationAvg);
                const diff2 = Math.round(stationAvg - lowestStation.avg);
                explanations.push(`Trạm này thấp hơn trạm ô nhiễm nhất ${diff1} µg/m³ và cao hơn trạm sạch nhất ${diff2} µg/m³.`);
            }
            
            // Đánh giá xu hướng trong ngày
            const values = stationPM25Data[stationId];
            const firstHalf = calculateAverage(values.slice(0, 6));
            const secondHalf = calculateAverage(values.slice(6, 12));
            
            if (secondHalf > firstHalf + 3) {
                explanations.push(`Chất lượng không khí có xu hướng xấu đi vào buổi chiều/tối.`);
            } else if (firstHalf > secondHalf + 3) {
                explanations.push(`Chất lượng không khí có xu hướng cải thiện vào buổi chiều/tối.`);
            } else {
                explanations.push(`Chất lượng không khí khá ổn định trong suốt cả ngày.`);
            }
            
            return explanations;
        }

        // Hàm cập nhật nội dung giải thích
        function updateStationInfo(stationId) {
            const listElement = document.getElementById('station-info-list');
            if (!listElement) return;
            
            const explanations = generateStationExplanation(stationId);
            listElement.innerHTML = explanations.map(text => `<li>${text}</li>`).join('');
        }

        // Hàm vẽ line chart
        function drawChart(selectedStationId) {
            const canvas = document.getElementById('pm25-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            // Make height responsive to container
            const container = document.getElementById('pm25-graph');
            const height = canvas.height = container ? container.offsetHeight - 40 : 400;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Chart settings
            const padding = { top: 50, right: 40, bottom: 60, left: 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Get data for selected station only
            const selectedData = stationPM25Data[selectedStationId];
            const minValue = Math.min(...selectedData) - 5;
            const maxValue = Math.max(...selectedData) + 5;
            const valueRange = maxValue - minValue;

            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            const gridLines = 5;
            for (let i = 0; i <= gridLines; i++) {
                const y = padding.top + (chartHeight / gridLines) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }

            // Draw vertical grid lines for time
            const timePoints = timeLabels.length;
            for (let i = 0; i < timePoints; i++) {
                const x = padding.left + (chartWidth / (timePoints - 1)) * i;
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, height - padding.bottom);
                ctx.stroke();
            }

            // Draw X-axis labels (thời gian)
            ctx.textAlign = 'center';
            ctx.fillStyle = '#666';
            timeLabels.forEach((label, index) => {
                const x = padding.left + (chartWidth / (timePoints - 1)) * index;
                ctx.fillText(label, x, height - padding.bottom + 20);
            });

            // Chỉ vẽ line chart cho trạm được chọn
            const stationColors = {
                's1': '#4fc3f7',
                's2': '#66bb6a',
                's3': '#ffa726',
                's4': '#ef5350',
                's5': '#ab47bc',
                's6': '#26a69a'
            };

            const data = selectedData;
            const color = stationColors[selectedStationId];

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;

            data.forEach((value, index) => {
                const x = padding.left + (chartWidth / (timePoints - 1)) * index;
                const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Draw data points
            data.forEach((value, index) => {
                const x = padding.left + (chartWidth / (timePoints - 1)) * index;
                const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;

                // Draw circle
                ctx.beginPath();
                ctx.fillStyle = color;
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();

                // Draw white border
                ctx.beginPath();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.stroke();
            });

            // Draw Y-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= gridLines; i++) {
                const value = maxValue - (valueRange / gridLines) * i;
                const y = padding.top + (chartHeight / gridLines) * i;
                ctx.fillText(Math.round(value), padding.left - 10, y + 4);
            }
        }

        // Hàm vẽ circular gauge chart
        function drawGaugeChart(value) {
            const canvas = document.getElementById('gauge-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const size = 500;  // Tăng từ 400 lên 500
            canvas.width = size;
            canvas.height = 400; // Tăng lên 400 để chữ không bị cắt

            const centerX = size / 2;
            const centerY = 200; // Điều chỉnh lại vị trí tâm
            const radius = 140; // Tăng từ 110 lên 140

            ctx.clearRect(0, 0, size, canvas.height);

            // Nửa vòng - gradient nhiều màu
            const maxValue = 500;
            const startAngle = Math.PI;  // Bắt đầu từ trái
            const endAngle = 0;          // Kết thúc ở phải
            const totalAngle = Math.PI;

            // Các mốc màu
            const colorStops = [
                { value: 0, color: '#4CAF50' },      // Xanh lá - Tốt
                { value: 50, color: '#8BC34A' },     // Xanh lá nhạt
                { value: 100, color: '#FFEB3B' },    // Vàng - Trung bình
                { value: 150, color: '#FF9800' },    // Cam - Kém
                { value: 200, color: '#FF5722' },    // Đỏ cam - Xấu
                { value: 300, color: '#E91E63' },    // Hồng đậm - Rất xấu
                { value: 500, color: '#9C27B0' }     // Tím - Nguy hại
            ];

            // Vẽ từng segment nhỏ để tạo gradient mượt
            const steps = 100;
            for (let i = 0; i < steps; i++) {
                const percent = i / steps;
                const currentValue = percent * maxValue;
                const angle1 = startAngle + (totalAngle * i / steps);
                const angle2 = startAngle + (totalAngle * (i + 1) / steps);

                // Tìm màu tương ứng
                let color = colorStops[0].color;
                for (let j = 0; j < colorStops.length - 1; j++) {
                    if (currentValue >= colorStops[j].value && currentValue < colorStops[j + 1].value) {
                        const localPercent = (currentValue - colorStops[j].value) / 
                                           (colorStops[j + 1].value - colorStops[j].value);
                        color = interpolateColor(colorStops[j].color, colorStops[j + 1].color, localPercent);
                        break;
                    }
                }

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, angle1, angle2);
                ctx.lineWidth = 30;  // Tăng từ 24 lên 30
                ctx.lineCap = 'round';
                ctx.strokeStyle = color;
                ctx.stroke();
            }

            // KHÔNG VẼ KIM NỮA
            
            // Vẽ labels xung quanh - CĂN ĐỀU KHOẢNG CÁCH
            function drawCurvedLabel(text, percent, radius) {
                ctx.save();

                // Arc vẽ từ Math.PI (trái) đến 2*Math.PI (phải)
                // Tương ứng với Math.PI (180°) + Math.PI * percent
                const angle = Math.PI + Math.PI * percent;

                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                // CHỈ dịch chuyển vị trí, KHÔNG xoay chữ
                ctx.translate(x, y);

                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(text, 0, 0);

                ctx.restore();
            }

            ctx.font = "15px Arial";  // Tăng từ 13px lên 15px
            ctx.fillStyle = "#000000";  // Đổi từ #2C3E50 sang đen #000000

            const r = 195; // Tăng từ 155 để phù hợp với gauge lớn hơn

            // Gauge: TRÁI (percent 0.0) = Math.PI = Xanh/Tốt
            //        PHẢI (percent 1.0) = 0 = Tím/Nguy hại
            drawCurvedLabel("Tốt", 0.0, r);
            drawCurvedLabel("Trung bình", 0.2, r);
            drawCurvedLabel("Kém", 0.4, r);
            drawCurvedLabel("Xấu", 0.6, r);
            drawCurvedLabel("Rất xấu", 0.8, r);
            drawCurvedLabel("Nguy hại", 1.0, r);
        }
        
        // Helper function để nội suy màu
        function interpolateColor(color1, color2, percent) {
            const r1 = parseInt(color1.slice(1, 3), 16);
            const g1 = parseInt(color1.slice(3, 5), 16);
            const b1 = parseInt(color1.slice(5, 7), 16);
            
            const r2 = parseInt(color2.slice(1, 3), 16);
            const g2 = parseInt(color2.slice(3, 5), 16);
            const b2 = parseInt(color2.slice(5, 7), 16);
            
            const r = Math.round(r1 + (r2 - r1) * percent);
            const g = Math.round(g1 + (g2 - g1) * percent);
            const b = Math.round(b1 + (b2 - b1) * percent);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // Hàm vẽ comparison bar chart
        function drawComparisonChart(stationId) {
            const canvas = document.getElementById('comparison-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = 350;

            ctx.clearRect(0, 0, width, height);

            const padding = { top: 40, right: 40, bottom: 70, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Data
            const whoGuideline = 15;
            const stationValue = calculateAverage(stationPM25Data[stationId]);
            const hcmcAverage = 35;

            const labels = ['0', 'WHO', `Trạm ${stationId.toUpperCase()}`, 'TP.HCM'];
            const values = [0, whoGuideline, stationValue, hcmcAverage];
            const maxValue = Math.max(...values) + 10;

            // Draw X-axis with arrow - TRẮNG ĐẬM
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(width - padding.right + 15, padding.top + chartHeight);
            ctx.stroke();
            
            // X-axis arrow (tam giác trắng)
            ctx.beginPath();
            ctx.moveTo(width - padding.right + 15, padding.top + chartHeight);
            ctx.lineTo(width - padding.right + 8, padding.top + chartHeight - 4);
            ctx.lineTo(width - padding.right + 8, padding.top + chartHeight + 4);
            ctx.closePath();
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();
            
            // Draw Y-axis - TRẮNG ĐẬM
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left, padding.top - 15);
            ctx.stroke();
            
            // Y-axis arrow (tam giác trắng)
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top - 15);
            ctx.lineTo(padding.left - 4, padding.top - 8);
            ctx.lineTo(padding.left + 4, padding.top - 8);
            ctx.closePath();
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();

            // Draw Y-axis labels - ĐEN THƯỜNG
            ctx.fillStyle = '#000000';
            ctx.font = '16px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = maxValue - (maxValue / 5) * i;
                const y = padding.top + (chartHeight / 5) * i;
                ctx.fillText(Math.round(value), padding.left - 10, y + 4);
            }

            // Draw bars
            const barWidth = chartWidth / labels.length;
            const barData = []; // Lưu data cho tooltip
            
            labels.forEach((label, index) => {
                if (index === 0) return; // Skip first bar (0)

                const value = values[index];
                const barHeight = (value / maxValue) * chartHeight;
                const x = padding.left + index * barWidth + barWidth * 0.2;
                const y = padding.top + chartHeight - barHeight;
                const w = barWidth * 0.6;
                const radius = 10;
                
                // Lưu data
                barData.push({ x, y, w, h: barHeight, value, label });

                // Draw bar with rounded top corners only (2 góc dưới vuông)
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.moveTo(x, y + barHeight);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.lineTo(x + w - radius, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
                ctx.lineTo(x + w, y + barHeight);
                ctx.lineTo(x, y + barHeight);
                ctx.closePath();
                ctx.fill();

                // Label - ĐEN THƯỜNG
                ctx.fillStyle = '#000000';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label, x + w/2, height - padding.bottom + 30);
            });

            // Y-axis label - ĐEN THƯỜNG
            ctx.save();
            ctx.translate(padding.left - 50, padding.top + chartHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#000000';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('µg/m³', 0, 0);
            ctx.restore();
            
            // Thêm tooltip
            if (canvas && !canvas.hasComparisonTooltip) {
                canvas.hasComparisonTooltip = true;
                
                let tooltip = document.getElementById('comparison-chart-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'comparison-chart-tooltip';
                    tooltip.style.cssText = 'position:absolute;background:#131E29;color:#fff;padding:8px 12px;border-radius:6px;font-size:13px;font-weight:600;display:none;pointer-events:none;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
                    canvas.parentElement.style.position = 'relative';
                    canvas.parentElement.appendChild(tooltip);
                }
                
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    let found = false;
                    for (const bar of barData) {
                        if (mouseX >= bar.x && mouseX <= bar.x + bar.w && 
                            mouseY >= bar.y && mouseY <= bar.y + bar.h) {
                            tooltip.textContent = `${Math.round(bar.value)}`;
                            tooltip.style.display = 'block';
                            tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                            tooltip.style.top = (e.clientY - rect.top - 30) + 'px';
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            }
        }

        // Khởi tạo dropdown cho trạm
        let currentStation = 's1';
        const stationDropdown = new Dropdown('station-dropdown', {
            items: [
                { value: 's1', text: 'S1 - Giao thông' },
                { value: 's2', text: 'S2 - Khu dân cư' },
                { value: 's3', text: 'S3 - Giao thông' },
                { value: 's4', text: 'S4 - Khu công nghiệp' },
                { value: 's5', text: 'S5 - Giao thông' },
                { value: 's6', text: 'S6 - Khu dân cư' }
            ],
            defaultItem: 's1',
            onSelect: function(value, text) {
                console.log('Đã chọn trạm:', value, text);
                currentStation = value;

                const data = stationPM25Data[value];
                const avgValue = calculateAverage(data);
                document.querySelector('.section-subtitle').textContent = `Trung bình ~ ${avgValue} µg/m³`;

                const statusBadges = document.querySelectorAll('.status-badge');
                statusBadges.forEach(badge => {
                    badge.className = 'status-badge';
                    if (avgValue > 50) {
                        badge.classList.add('status-bad');
                        badge.textContent = 'Xấu';
                    } else if (avgValue > 35) {
                        badge.classList.add('status-moderate');
                        badge.textContent = 'Trung bình';
                    } else {
                        badge.classList.add('status-good');
                        badge.textContent = 'Tốt';
                    }
                });

                document.getElementById('station-name-display').textContent = value.toUpperCase();
                document.getElementById('gauge-value').textContent = Math.round(avgValue);

                drawChart(value);
                drawGaugeChart(avgValue);
                drawComparisonChart(value);
                updateStationInfo(value); // Cập nhật giải thích trạm
            }
        });

        const initialAvg = calculateAverage(stationPM25Data['s1']);
        document.getElementById('gauge-value').textContent = Math.round(initialAvg);
        drawChart('s1');
        drawGaugeChart(initialAvg);
        drawComparisonChart('s1');
        updateStationInfo('s1'); // Cập nhật giải thích ban đầu

        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                const avg = calculateAverage(stationPM25Data[currentStation]);
                document.getElementById('gauge-value').textContent = Math.round(avg);
                drawChart(currentStation);
                drawGaugeChart(avg);
                drawComparisonChart(currentStation);
            }, 250);
        });
    });
</script>

<!-- ===================== ADDED: GOVERNMENT LOGIC + DROPDOWNS + CHARTS (FIX CANVAS) ===================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const govSection = document.getElementById('government-extra-section');
    const btnPublic = document.querySelector('.text-wrapper-76[data-mode="public"]');
    const btnMgmt = document.querySelector('.text-wrapper-77[data-mode="management"]');

    function getCurrentStationId() {
        const stationText = (document.getElementById('station-name-display')?.textContent || 'S1').trim();
        return stationText.toLowerCase();
    }

    function setGovVisible(isVisible) {
        if (!govSection) return;
        govSection.style.display = isVisible ? 'block' : 'none';
        localStorage.setItem('airsense_role', isVisible ? 'government' : 'public');

        // FIX: đợi layout render xong -> canvas mới có width
        if (isVisible) {
            requestAnimationFrame(() => {
                updateGovernmentUI(getCurrentStationId());
            });
        }
    }

    if (btnPublic) btnPublic.addEventListener('click', function () { setGovVisible(false); });
    if (btnMgmt) btnMgmt.addEventListener('click', function () { setGovVisible(true); });

    const savedRole = localStorage.getItem('airsense_role') || 'public';
    setGovVisible(savedRole === 'government');

    const WHO_GUIDELINE = 15;
    const timeLabelsGov = ['0:00', '2:00', '4:00', '6:00', '8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'];
    const stationPM25DataGov = {
        's1': [32, 34, 36, 38, 40, 42, 41, 39, 37, 35, 33, 32],
        's2': [25, 27, 29, 31, 30, 32, 31, 29, 28, 27, 26, 25],
        's3': [35, 37, 39, 41, 43, 45, 44, 42, 40, 38, 36, 35],
        's4': [45, 47, 49, 51, 53, 55, 54, 52, 50, 48, 46, 45],
        's5': [30, 32, 34, 36, 35, 37, 36, 34, 33, 32, 31, 30],
        's6': [22, 24, 26, 28, 27, 29, 28, 26, 25, 24, 23, 22]
    };

    const stationType = {
        s1: 'traffic',
        s2: 'residential',
        s3: 'traffic',
        s4: 'industrial',
        s5: 'traffic',
        s6: 'residential'
    };

    const typeLabelVi = {
        traffic: 'Giao thông',
        residential: 'Khu dân cư',
        industrial: 'Khu công nghiệp'
    };

    function average(arr) {
        return Math.round((arr.reduce((a, b) => a + b, 0) / arr.length) * 10) / 10;
    }

    // FIX: width fallback + never 0
    function prepareCanvas(canvasId, height) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;

        const ctx = canvas.getContext('2d');

        const w1 = canvas.offsetWidth;
        const w2 = canvas.parentElement ? canvas.parentElement.clientWidth : 0;
        const width = canvas.width = (w1 && w1 > 10) ? w1 : ((w2 && w2 > 10) ? w2 : 600);

        canvas.height = height;
        ctx.clearRect(0, 0, width, height);
        return { ctx, width, height };
    }

    function drawBarChart({ canvasId, title, labels, values, yLabel, valueSuffix = '' }) {
        const pack = prepareCanvas(canvasId, 280);
        if (!pack) return;

        const { ctx, width, height } = pack;
        const padding = { top: 40, right: 30, bottom: 60, left: 60 };
        const chartW = width - padding.left - padding.right;
        const chartH = height - padding.top - padding.bottom;

        const maxVal = Math.max(...values, 0) + 5;

        ctx.fillStyle = '#131E29';
        ctx.font = '600 14px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(title, padding.left, 22);

        // Draw X-axis with arrow - TRẮNG ĐẬM
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top + chartH);
        ctx.lineTo(width - padding.right + 15, padding.top + chartH);
        ctx.stroke();
        
        // X-axis arrow (tam giác trắng)
        ctx.beginPath();
        ctx.moveTo(width - padding.right + 15, padding.top + chartH);
        ctx.lineTo(width - padding.right + 8, padding.top + chartH - 4);
        ctx.lineTo(width - padding.right + 8, padding.top + chartH + 4);
        ctx.closePath();
        ctx.fillStyle = '#FFFFFF';
        ctx.fill();
        
        // Draw Y-axis - TRẮNG ĐẬM
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top + chartH);
        ctx.lineTo(padding.left, padding.top - 15);
        ctx.stroke();
        
        // Y-axis arrow (tam giác trắng)
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top - 15);
        ctx.lineTo(padding.left - 4, padding.top - 8);
        ctx.lineTo(padding.left + 4, padding.top - 8);
        ctx.closePath();
        ctx.fillStyle = '#FFFFFF';
        ctx.fill();

        // Draw Y-axis labels - ĐEN THƯỜNG (không đậm)
        const ticks = 5;
        ctx.font = '12px Arial';
        ctx.fillStyle = '#000000';
        ctx.textAlign = 'right';
        for (let i = 0; i <= ticks; i++) {
            const y = padding.top + (chartH / ticks) * i;
            const v = maxVal - (maxVal / ticks) * i;
            ctx.fillText(Math.round(v), padding.left - 10, y + 4);
        }

        const barW = chartW / labels.length;
        const barData = []; // Lưu vị trí các cột để dùng cho tooltip
        
        ctx.textAlign = 'center';
        labels.forEach((lb, i) => {
            const val = values[i];
            const h = (val / maxVal) * chartH;
            const x = padding.left + i * barW + barW * 0.2;
            const y = padding.top + chartH - h;
            const w = barW * 0.6;
            const radius = 10;
            
            // Lưu thông tin cột
            barData.push({ x, y, w, h, value: val, label: lb });

            // Draw bar with rounded top corners only (2 góc dưới vuông)
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.moveTo(x, y + h);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.lineTo(x + w - radius, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
            ctx.lineTo(x + w, y + h);
            ctx.lineTo(x, y + h);
            ctx.closePath();
            ctx.fill();

            // Label - ĐEN THƯỜNG (không đậm)
            ctx.fillStyle = '#000000';
            ctx.font = '12px Arial';
            ctx.fillText(lb, x + w / 2, height - padding.bottom + 20);
        });

        // Y-axis label - ĐEN THƯỜNG (không đậm)
        ctx.save();
        ctx.translate(padding.left - 45, padding.top + chartH / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = '#000000';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(yLabel, 0, 0);
        ctx.restore();
        
        // Thêm tooltip khi hover
        const canvas = document.getElementById(canvasId);
        if (canvas && !canvas.hasTooltip) {
            canvas.hasTooltip = true;
            
            // Tạo tooltip div
            let tooltip = document.getElementById(`${canvasId}-tooltip`);
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = `${canvasId}-tooltip`;
                tooltip.style.cssText = 'position:absolute;background:#131E29;color:#fff;padding:8px 12px;border-radius:6px;font-size:13px;font-weight:600;display:none;pointer-events:none;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
                canvas.parentElement.style.position = 'relative';
                canvas.parentElement.appendChild(tooltip);
            }
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                let found = false;
                for (const bar of barData) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.w && 
                        mouseY >= bar.y && mouseY <= bar.y + bar.h) {
                        tooltip.textContent = `${Math.round(bar.value)}${valueSuffix}`;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                        tooltip.style.top = (e.clientY - rect.top - 30) + 'px';
                        found = true;
                        break;
                    }
                }
                
                if (!found) {
                    tooltip.style.display = 'none';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
    }

    let govSameTypeDropdown = null;
    let govDiffTypeDropdown = null;

    let sameTypeMode = 'all';
    let diffTypeStation = null;

    function buildSameTypeItems(currentStationId) {
        const t = stationType[currentStationId];
        const sameStations = Object.keys(stationType).filter(s => stationType[s] === t);
        const items = [{ value: 'all', text: 'Tất cả' }];
        sameStations.forEach(s => items.push({ value: s, text: `${s.toUpperCase()} - ${typeLabelVi[t] || t}` }));
        return items;
    }

    function buildDiffTypeItems(currentStationId) {
        const t = stationType[currentStationId];
        const diffStations = Object.keys(stationType).filter(s => stationType[s] !== t);
        return diffStations.map(s => {
            const tp = stationType[s];
            return { value: s, text: `${s.toUpperCase()} - ${typeLabelVi[tp] || tp}` };
        });
    }

    function drawExceedanceHourly(stationId) {
        const exceed = stationPM25DataGov[stationId].map(v => Math.max(v - WHO_GUIDELINE, 0));
        drawBarChart({
            canvasId: 'exceedance-hourly-chart',
            title: `Above WHO (${WHO_GUIDELINE}) by hour — ${stationId.toUpperCase()}`,
            labels: timeLabelsGov,
            values: exceed,
            yLabel: 'µg/m³ above'
        });
    }

    function drawSameTypeComparison(currentStationId) {
        const t = stationType[currentStationId];
        const currentAvg = average(stationPM25DataGov[currentStationId]);

        if (sameTypeMode === 'all') {
            const sameStations = Object.keys(stationType).filter(s => stationType[s] === t);
            drawBarChart({
                canvasId: 'same-type-comparison-chart',
                title: `Same type: ${typeLabelVi[t] || t} — Daily average`,
                labels: sameStations.map(s => s.toUpperCase()),
                values: sameStations.map(s => average(stationPM25DataGov[s])),
                yLabel: 'µg/m³ (avg)'
            });
            return;
        }

        const other = sameTypeMode;
        drawBarChart({
            canvasId: 'same-type-comparison-chart',
            title: `Same type compare (avg): WHO vs ${currentStationId.toUpperCase()} vs ${other.toUpperCase()}`,
            labels: ['WHO', currentStationId.toUpperCase(), other.toUpperCase()],
            values: [WHO_GUIDELINE, currentAvg, average(stationPM25DataGov[other])],
            yLabel: 'µg/m³ (avg)'
        });
    }

    function drawDiffTypeComparison(currentStationId) {
        const currentAvg = average(stationPM25DataGov[currentStationId]);
        const fallback = Object.keys(stationType).find(s => stationType[s] !== stationType[currentStationId]);
        const other = diffTypeStation || fallback || currentStationId;

        drawBarChart({
            canvasId: 'diff-type-comparison-chart',
            title: `Different type compare (avg): WHO vs ${currentStationId.toUpperCase()} vs ${other.toUpperCase()}`,
            labels: ['WHO', currentStationId.toUpperCase(), other.toUpperCase()],
            values: [WHO_GUIDELINE, currentAvg, average(stationPM25DataGov[other])],
            yLabel: 'µg/m³ (avg)'
        });
    }

    function updateGovernmentTitles(stationId) {
        const stationUpper = stationId.toUpperCase();
        const el1 = document.getElementById('gov-station-name-exceedance');
        const el2 = document.getElementById('gov-station-name-same-type');
        const el3 = document.getElementById('gov-station-name-diff-type');
        if (el1) el1.textContent = stationUpper;
        if (el2) el2.textContent = stationUpper;
        if (el3) el3.textContent = stationUpper;
    }

    function initOrUpdateGovDropdowns(currentStationId) {
        const sameItems = buildSameTypeItems(currentStationId);
        const defaultSame = (sameTypeMode && sameItems.some(it => it.value === sameTypeMode)) ? sameTypeMode : 'all';
        sameTypeMode = defaultSame;

        govSameTypeDropdown = new Dropdown('gov-same-type-dropdown', {
            items: sameItems,
            defaultItem: defaultSame,
            onSelect: function (value, text) {
                sameTypeMode = value;
                drawSameTypeComparison(currentStationId);
            }
        });

        const diffItems = buildDiffTypeItems(currentStationId);
        const defaultDiff = (diffTypeStation && diffItems.some(it => it.value === diffTypeStation))
            ? diffTypeStation
            : (diffItems[0]?.value || null);
        diffTypeStation = defaultDiff;

        govDiffTypeDropdown = new Dropdown('gov-diff-type-dropdown', {
            items: diffItems,
            defaultItem: defaultDiff,
            onSelect: function (value, text) {
                diffTypeStation = value;
                drawDiffTypeComparison(currentStationId);
            }
        });
    }

    function updateGovernmentCharts(currentStationId) {
        if (!stationPM25DataGov[currentStationId]) currentStationId = 's1';
        updateGovernmentTitles(currentStationId);
        drawExceedanceHourly(currentStationId);
        drawSameTypeComparison(currentStationId);
        drawDiffTypeComparison(currentStationId);
    }

    function updateGovernmentUI(currentStationId) {
        initOrUpdateGovDropdowns(currentStationId);
        updateGovernmentCharts(currentStationId);
    }

    const stationNameEl = document.getElementById('station-name-display');
    if (stationNameEl) {
        const obs = new MutationObserver(function () {
            const isGov = (localStorage.getItem('airsense_role') === 'government');
            if (!isGov) return;
            requestAnimationFrame(() => updateGovernmentUI(getCurrentStationId()));
        });
        obs.observe(stationNameEl, { childList: true, characterData: true, subtree: true });
    }

    let resizeTimer2;
    window.addEventListener('resize', function () {
        clearTimeout(resizeTimer2);
        resizeTimer2 = setTimeout(function () {
            const isGov = (localStorage.getItem('airsense_role') === 'government');
            if (!isGov) return;
            updateGovernmentCharts(getCurrentStationId());
        }, 250);
    });
});
</script>
<!-- ===================== /ADDED: GOVERNMENT LOGIC + DROPDOWNS + CHARTS ===================== -->

<!-- API Integration Script - KẾT NỐI VỚI BACKEND -->
<script src="../assets/js/station-tracking.js"></script>

</body>
</html>